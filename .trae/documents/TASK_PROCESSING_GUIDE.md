# 任务处理指南

文档转换服务的任务处理流程说明，包括核心组件、处理流程和最佳实践。

## 🏗️ 系统架构

### 核心组件

- **API服务器**: FastAPI框架，提供REST接口
- **任务处理器**: 异步任务调度，支持多线程并发
- **文档转换**: LibreOffice + MinerU 2.0转换引擎
- **存储服务**: S3兼容存储（MinIO）
- **Web界面**: Gradio用户界面

### 队列系统

```
任务创建 → 优先级队列 → 处理队列 → 状态更新 → 完成
```

**队列类型**:
- 高优先级队列（<5分钟）
- 普通优先级队列（<30分钟）
- 低优先级队列（<2小时）

## 🔄 任务生命周期

### 任务状态

- **pending**: 等待处理
- **processing**: 正在处理
- **completed**: 处理完成
- **failed**: 处理失败（可重试3次）

### 优先级系统

- **urgent**: <5分钟处理
- **high**: <15分钟处理
- **normal**: <30分钟处理
- **low**: <2小时处理

### 处理流程

```
任务创建 → 参数验证 → 文件下载 → 文档转换 → 结果上传 → 任务完成
```

### 处理时间估算

- **PDF转Markdown**: 30秒-3分钟
- **Office转PDF**: 10-90秒
- **Office转Markdown**: 40-90秒

## 📋 处理阶段

### 1. 任务创建

**API请求**:
```bash
curl -X POST "http://localhost:8000/api/tasks/pdf-to-markdown" \
  -F "file=@document.pdf" \
  -F "extract_images=true"
```

**参数验证**:
- 任务类型检查
- 文件格式验证
- 参数范围检查

### 2. 文件处理

**下载阶段**:
- 从S3下载输入文件
- 创建临时工作空间
- 文件完整性验证

**转换阶段**:
- PDF转Markdown: 使用MinerU 2.0引擎
- Office转PDF: 使用LibreOffice
- 图片提取和OCR识别

**上传阶段**:
- 转换结果上传到S3
- 生成下载链接
- 清理临时文件

## 🔧 错误处理

### 重试机制

- **最大重试次数**: 3次
- **重试间隔**: 指数退避（1s, 2s, 4s）
- **重试条件**: 网络错误、临时故障

### 错误类型

- **参数错误**: 立即失败，不重试
- **网络错误**: 自动重试
- **转换错误**: 记录详细日志
- **存储错误**: 重试上传

## 📊 监控指标

### 性能指标

- **任务吞吐量**: 每分钟处理任务数
- **平均处理时间**: 按任务类型统计
- **成功率**: 成功/总任务数
- **队列长度**: 实时队列状态

### 系统资源

- **CPU使用率**: 转换引擎负载
- **内存使用**: 大文件处理监控
- **磁盘空间**: 临时文件清理
- **网络带宽**: S3传输速度

## 🚀 最佳实践

### 性能优化

1. **批量处理**: 合并小文件任务
2. **缓存策略**: 重复文件检测
3. **资源管理**: 及时清理临时文件
4. **并发控制**: 根据系统资源调整

### 使用建议

1. **文件大小**: 建议<50MB单个文件
2. **格式选择**: 优先使用原生格式
3. **参数配置**: 根据需求调整转换参数
4. **错误处理**: 实现回调接口处理失败任务

## 🔗 相关文档

- [API使用指南](./API_COMPLETE_GUIDE.md)
- [项目概览](./PROJECT_OVERVIEW.md)
- [测试报告](./文档转换功能测试报告.md)

---

*更多技术细节请参考源码注释和在线文档*