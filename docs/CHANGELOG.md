# 更新日志 (CHANGELOG)

## [v1.2.0] - 2025-08-08

### 🎉 新增功能

#### 图片转Markdown功能
- **新增任务类型**: `image_to_markdown` - 支持PNG、JPG、JPEG图片转Markdown
- **OCR识别**: 集成MinerU强大的OCR功能，支持中文文档识别
- **批量处理**: 支持`batch_image_to_markdown`批量图片转换
- **高质量输出**: 自动识别表格、文本布局，生成规范的Markdown格式

#### 任务重试系统
- **单个任务重试**: `POST /api/tasks/{task_id}/retry` - 重试指定失败任务
- **批量重试**: `POST /api/tasks/retry-failed` - 一键重试所有失败任务
- **智能重试**: 自动重置任务状态、清除错误信息、重新排队处理
- **重试状态跟踪**: 完整的重试历史和状态管理

#### 任务类型修改功能
- **类型修改API**: `PUT /api/tasks/{task_id}/task-type` - 修改任务类型
- **类型验证**: 自动验证任务类型有效性
- **失败任务修复**: 支持修改类型不匹配的失败任务
- **即时生效**: 修改后可立即重试执行

### 🔧 技术改进

#### MinerU集成优化
- **命令行调用**: 使用MinerU命令行工具进行图片OCR处理
- **临时目录管理**: 自动创建和清理临时工作目录
- **GPU内存管理**: 智能GPU内存清理和资源管理
- **错误处理**: 完整的异常处理和超时控制

#### 数据库功能增强
- **状态查询**: 新增`get_tasks_by_status`方法支持按状态查询任务
- **批量操作**: 优化批量任务状态更新性能
- **重试计数**: 完善重试次数跟踪和限制

#### API文档完善
- **重试功能文档**: 详细的重试API使用说明
- **任务类型说明**: 完整的支持任务类型列表
- **示例代码**: 提供curl命令示例

### 🐛 问题修复

#### 任务处理优化
- **类型匹配检查**: 增强文件类型与任务类型的匹配验证
- **错误信息优化**: 更清晰的错误提示和日志记录
- **状态同步**: 修复任务状态更新的并发问题

#### 文件处理改进
- **路径处理**: 优化文件路径处理和特殊字符支持
- **临时文件清理**: 改进临时文件的自动清理机制
- **输出格式**: 统一输出文件格式和命名规范

### 📊 性能提升

#### 并发处理
- **多任务并行**: 支持多个图片同时进行OCR处理
- **资源优化**: 优化GPU和内存资源使用
- **队列管理**: 改进任务队列的调度效率

#### 存储优化
- **S3集成**: 完善S3上传下载的错误处理
- **文件压缩**: 优化输出文件的存储效率
- **缓存机制**: 改进临时文件的缓存策略

### 🔒 安全增强

#### 输入验证
- **任务类型验证**: 严格的任务类型有效性检查
- **文件格式验证**: 增强文件格式和大小限制
- **权限控制**: 改进任务操作的权限验证

### 📈 测试验证

#### 功能测试
- **图片转换测试**: 验证PNG/JPG/JPEG图片转Markdown功能
- **重试机制测试**: 验证单个和批量重试功能
- **类型修改测试**: 验证任务类型修改和重新执行
- **端到端测试**: 完整的S3下载-转换-上传流程测试

#### 性能测试
- **并发处理**: 测试多任务并行处理能力
- **大文件处理**: 验证大尺寸图片的处理性能
- **内存使用**: 监控GPU和系统内存使用情况

### 🚀 部署说明

#### 环境要求
- **MinerU**: 确保MinerU环境正确配置
- **GPU支持**: 推荐使用GPU加速OCR处理
- **存储空间**: 预留足够的临时文件存储空间

#### 配置更新
- **任务类型**: 新增image_to_markdown相关配置
- **重试参数**: 可配置重试次数和间隔
- **OCR设置**: 可配置OCR语言和精度参数

### 📝 API变更

#### 新增接口
- `POST /api/tasks/{task_id}/retry` - 重试单个任务
- `POST /api/tasks/retry-failed` - 批量重试失败任务
- `PUT /api/tasks/{task_id}/task-type` - 修改任务类型

#### 任务类型扩展
- `image_to_markdown` - 图片转Markdown
- `batch_image_to_markdown` - 批量图片转Markdown

### 🎯 使用示例

#### 图片转Markdown
```bash
curl -X POST "http://localhost:8000/api/tasks/create" \
  -F "task_type=image_to_markdown" \
  -F "bucket_name=your-bucket" \
  -F "file_path=path/to/image.png" \
  -F "platform=your-platform"
```

#### 重试失败任务
```bash
curl -X POST "http://localhost:8000/api/tasks/retry-failed"
```

#### 修改任务类型
```bash
curl -X PUT "http://localhost:8000/api/tasks/1/task-type" \
  -F "new_task_type=image_to_markdown"
```

---

## [v1.1.0] - 2025-08-07

### 基础功能
- 文档转换服务基础架构
- PDF和Office文档转换功能
- S3存储集成
- 任务队列系统
- 基础API接口

---

**注意**: 此版本包含重大功能更新，建议在部署前进行充分测试。
